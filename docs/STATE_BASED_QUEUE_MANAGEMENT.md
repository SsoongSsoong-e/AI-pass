# State-Based Queue Management: μ—¬κ¶ μ‚¬μ§„ νΉμ„±μ— λ§μ¶ μµμ ν™”

## μ—¬κ¶ μ‚¬μ§„μ νΉμμ„± (μ •ν™•ν• κ·κ²©)

- **μ •ν™•μ„± μ”κµ¬**: μ–Όκµ΄ κ°λ„, ν‘μ •, λ μƒνƒ λ“± λ¨λ“  μ΅°κ±΄μ΄ μ •ν™•ν λ§μ•„μ•Ό ν•¨
- **μΉ΄μ΄νΈλ‹¤μ΄ μ¤‘ μµμ‹  ν¬μ¦κ°€ κ°€μ¥ μ¤‘μ”**: μ‚¬μ©μκ°€ μ¬λ°”λ¥Έ ν¬μ¦λ¥Ό μ·¨ν• ν›„ 3μ΄ μΉ΄μ΄νΈλ‹¤μ΄μ΄ μ‹μ‘λλ©΄, κ·Έ μκ°„μ ν¬μ¦κ°€ κ°€μ¥ μ •ν™•ν•¨
- **λ§μ§€λ§‰ ν¬μ¦ κ²€μ¦μ μ¤‘μ”μ„±**: μΉ΄μ΄νΈλ‹¤μ΄ μ¤‘ ν¬μ¦ λ³€κ²½ μ‹ μµμ‹  ν¬μ¦κ°€ μ¦‰μ‹ λ°μλμ–΄μ•Ό ν•¨

## κΈ°μ΅΄ FIFO νμ ν•κ³„μ 

### λ¬Έμ  μƒν™©

- ν‰κ·  μ²λ¦¬ μ‹κ°„(μ•½ 200-230ms)μ΄ μ „μ†΅ μ£ΌκΈ°λ³΄λ‹¤ μ§§κ±°λ‚ λΉ„μ·ν• κ²½μ° νμ— μμ£Ό μ μ¬λμ§€ μ•μ
  - κΈ°μ΅΄ 1μ΄(1000ms) κ°„κ²©μ—μ„λ” ν λ„μ μ΄ κ±°μ λ°μƒν•μ§€ μ•μ•μΌλ‚, μ‹¤μ‹κ°„μ„±μ„ λ†’μ΄κΈ° μ„ν•΄ μ „μ†΅ μ£ΌκΈ°λ¥Ό 100msλ΅ λ‹¨μ¶•ν•λ©΄μ„ μ²λ¦¬ μ‹κ°„ λ³€λ™μ„±(μµμ† 187ms ~ μµλ€ 408ms)μΌλ΅ μΈν•΄ ν λ„μ  λ°μƒ

- ν•μ§€λ§ FIFO νλ΅ μΈν•΄ ν„μ¬ μ‹μ  λ€λΉ„ μ¤λλ μ”μ²­μ΄ λ¨Όμ € μ²λ¦¬λμ–΄ μµμ‹  ν¬μ¦ κ²€μ¦μ΄ μ§€μ—°λ¨
  - μ „μ†΅ μ£ΌκΈ°λ¥Ό λ‹¨μ¶•ν•μ—¬ μ‹¤μ‹κ°„μ„±μ„ λ†’μ€μ§€λ§, ν‰κ·  μ²λ¦¬ μ‹κ°„(200-230ms)μ΄ μ „μ†΅ μ£ΌκΈ°(100ms)λ³΄λ‹¤ κΈΈμ–΄μ§€λ” κ²½μ° νμ— μ”μ²­μ΄ λ„μ λλ©°, FIFO νμ κµ¬μ΅°μ  ν•κ³„λ΅ μ¤λλ μ”μ²­λ¶€ν„° μμ°¨ μ²λ¦¬λμ–΄ μµμ‹  ν¬μ¦ κ²€μ¦μ΄ λ’¤λ΅ λ°€λ¦Ό
  - μ‚¬μ©μκ°€ ν¬μ¦λ¥Ό μ΅°μ •ν•΄λ„ μ¦‰μ‹ λ°μλμ§€ μ•μ•„ μ‚¬μ©μ„± μ €ν•΄

<aside>

π’΅

**μ •λ¦¬:**

κΈ°μ΅΄ 1μ΄ κ°„κ²©μ—μ„λ” ν λ„μ μ΄ κ±°μ μ—†μ—μΌλ‚, **μ‹¤μ‹κ°„μ„± ν–¥μƒ**μ„ μ„ν•΄ μ „μ†΅ μ£ΌκΈ°λ¥Ό 100msλ΅ λ‹¨μ¶•ν•λ©΄μ„ ν‰κ·  μ²λ¦¬ μ‹κ°„(200-230ms)κ³Ό μ²λ¦¬ μ‹κ°„ λ³€λ™μ„±μΌλ΅ μΈν•΄ **ν λ„μ μ΄ λ°μƒ**ν•κ³ , **FIFO νμ κµ¬μ΅°μ  ν•κ³„λ΅ μ¤λλ μ”μ²­λ¶€ν„° μμ°¨ μ²λ¦¬**λμ–΄ μΉ΄μ΄νΈλ‹¤μ΄ μ¤‘ **μµμ‹  ν¬μ¦ κ²€μ¦μ΄ μ§€μ—°λμ–΄ μ‚¬μ©μ„± μ €ν•΄ λ¬Έμ κ°€ λ°μƒ**ν•¨.

</aside>

---

## State-Based Queue Management λ„μ…

### ν•µμ‹¬ κ°λ…

- **μƒνƒ κΈ°λ° ν κ΄€λ¦¬**: κ²€μ¦ κ²°κ³Όμ— λ”°λΌ ν μ²λ¦¬ μ „λµμ„ λ™μ μΌλ΅ λ³€κ²½
- **μΌλ° λ¨λ“ (`allPassed = false`)**: 100ms κ°„κ²© μ „μ†΅, νμ— μ μ¬ν•μ—¬ μμ°¨ μ²λ¦¬ (FIFO)
- **μΉ΄μ΄νΈλ‹¤μ΄ λ¨λ“ (`allPassed = true`)**: 720ms κ°„κ²© μ „μ†΅, νμ— μ μ¬ν•μ§€ μ•κ³  μ¦‰μ‹ μ²λ¦¬

### μΉ΄μ΄νΈλ‹¤μ΄ λ¨λ“ μ „μ†΅ κ°„κ²© κ³„μ‚°

μΉ΄μ΄νΈλ‹¤μ΄ λ¨λ“μ—μ„λ” **μ •ν™•ν 1μ΄ κ°„κ²©μΌλ΅ ν¬μ¦ κ²€μ¦**μ΄ μ΄λ£¨μ–΄μ§€λ„λ΅ μ„¤κ³„λμ—μµλ‹λ‹¤.

**κ³„μ‚° κ³µμ‹:**
```
ν΄λΌμ΄μ–ΈνΈ μ „μ†΅ κ°„κ²© = 1000ms - (μ„λ²„ μ²λ¦¬ μ‹κ°„ + λ„¤νΈμ›ν¬ μ§€μ—°)
```

**μ‹¤μ  μ μ©:**
- μ„λ²„ μ²λ¦¬ μ‹κ°„: ν‰κ·  230ms (μµλ€ 408ms)
- λ„¤νΈμ›ν¬ μ§€μ—°: μ•½ 50ms
- μ΄ μ‘λ‹µ μ‹κ°„: μ•½ 280ms (ν‰κ·  κΈ°μ¤€)
- **ν΄λΌμ΄μ–ΈνΈ μ „μ†΅ κ°„κ²©: 1000ms - 280ms = 720ms**

μ΄λ¥Ό ν†µν•΄ ν΄λΌμ΄μ–ΈνΈκ°€ 720msλ§λ‹¤ μ „μ†΅ν•λ©΄, μ„λ²„ μ²λ¦¬μ™€ λ„¤νΈμ›ν¬ μ§€μ—°μ„ κ³ λ ¤ν•μ—¬ μ‹¤μ λ΅ μ•½ 1μ΄(1000ms) κ°„κ²©μΌλ΅ ν¬μ¦ κ²€μ¦μ΄ μ΄λ£¨μ–΄μ§‘λ‹λ‹¤.

### μƒνƒ μ „ν™ λ©”μ»¤λ‹μ¦

1. **μΌλ° λ¨λ“ β†’ μΉ΄μ΄νΈλ‹¤μ΄ λ¨λ“**
   - κ²€μ¦ κ²°κ³Ό `[1,1,1,1,1]` λ°ν™ μ‹
   - μ„λ²„: μΉ΄μ΄νΈλ‹¤μ΄ λ¨λ“ ν™μ„±ν™” (`countdownMode.set(clientId, true)`)
   - μ„λ²„: νμ— μλ” λ¨λ“  μ¤λλ μ”μ²­ μ·¨μ† λ° λ©”λ¨λ¦¬ ν•΄μ 
   - μ„λ²„: ν΄λΌμ΄μ–ΈνΈμ— κ²€μ¦ μ„±κ³µ κ²°κ³Ό μ „μ†΅
   - ν΄λΌμ΄μ–ΈνΈ: κ²€μ¦ κ²°κ³Ό μμ‹  β†’ `isValid = true`
   - ν΄λΌμ΄μ–ΈνΈ: μ „μ†΅ κ°„κ²© λ³€κ²½ (100ms β†’ 720ms)

2. **μΉ΄μ΄νΈλ‹¤μ΄ λ¨λ“ β†’ μΌλ° λ¨λ“**
   - κ²€μ¦ κ²°κ³Όκ°€ `[1,1,1,1,1]`μ΄ μ•„λ‹ λ•
   - μ„λ²„: μΉ΄μ΄νΈλ‹¤μ΄ λ¨λ“ λΉ„ν™μ„±ν™” (`countdownMode.set(clientId, false)`)
   - μ„λ²„: ν΄λΌμ΄μ–ΈνΈμ— κ²€μ¦ μ‹¤ν¨ κ²°κ³Ό μ „μ†΅
   - ν΄λΌμ΄μ–ΈνΈ: κ²€μ¦ κ²°κ³Ό μμ‹  β†’ `isValid = false`
   - ν΄λΌμ΄μ–ΈνΈ: μ „μ†΅ κ°„κ²© λ³€κ²½ (720ms β†’ 100ms)

### λ™μ‘ λ°©μ‹

#### μΌλ° λ¨λ“ (100ms κ°„κ²©)

```
ν΄λΌμ΄μ–ΈνΈ β†’ μ„λ²„: 100ms κ°„κ²©μΌλ΅ μ΄λ―Έμ§€ μ „μ†΅
μ„λ²„: λ¨λ“  μ”μ²­μ„ νμ— μ¶”κ°€ (queue.queue.push)
μ„λ²„: νμ—μ„ μμ°¨μ μΌλ΅ μ²λ¦¬ (FIFO)
μ„λ²„ β†’ ν΄λΌμ΄μ–ΈνΈ: κ²€μ¦ κ²°κ³Ό λ°ν™
```

#### μΉ΄μ΄νΈλ‹¤μ΄ λ¨λ“ (720ms κ°„κ²©, μ‹¤μ  1μ΄ κ°„κ²© ν¬μ¦ κ²€μ¦)

```
ν΄λΌμ΄μ–ΈνΈ β†’ μ„λ²„: 720ms κ°„κ²©μΌλ΅ μ΄λ―Έμ§€ μ „μ†΅
μ„λ²„: νμ— μ¶”κ°€ν•μ§€ μ•κ³  μ¦‰μ‹ μ²λ¦¬ μ‹μ‘
μ„λ²„: μ²λ¦¬ μ¤‘μΈ μ”μ²­μ΄ μμΌλ©΄ μ·¨μ†ν•κ³  μµμ‹  μ”μ²­ μ²λ¦¬
μ„λ²„ β†’ ν΄λΌμ΄μ–ΈνΈ: κ²€μ¦ κ²°κ³Ό λ°ν™ (ν‰κ·  280ms μ΄λ‚΄)
β†’ μ‹¤μ  ν¬μ¦ κ²€μ¦ κ°„κ²©: μ•½ 1μ΄ (720ms μ „μ†΅ + 280ms μ²λ¦¬)
```

**μΉ΄μ΄νΈλ‹¤μ΄ λ¨λ“ μ§„μ… μ‹ ν μ •λ¦¬:**
- κ²€μ¦ μ„±κ³µ μ‹μ μ— νμ— λ‚¨μ•„μλ” λ¨λ“  μ”μ²­ μ·¨μ†
- `AbortController.abort()`λ΅ μ”μ²­ μ·¨μ†
- `releaseMemory()`λ΅ λ©”λ¨λ¦¬ ν•΄μ 
- ν λΉ„μ°κΈ° (`queue.queue = []`)

## State-Based Queue Management μ¥μ 

### 1. μΉ΄μ΄νΈλ‹¤μ΄ μ¤‘ μµμ‹  ν¬μ¦ μ¦‰μ‹ μ²λ¦¬

- μ—¬κ¶ μ‚¬μ§„μ μ •ν™•ν• κ·κ²© μ”κµ¬μ‚¬ν•­ μ¶©μ΅±
- μ‚¬μ©μκ°€ ν¬μ¦λ¥Ό μ΅°μ •ν•  λ•λ§λ‹¤ μ‹¤μ‹κ°„ ν”Όλ“λ°± μ κ³µ
- λ§μ§€λ§‰ ν¬μ¦ κ²€μ¦μ μ¤‘μ”μ„± λ³΄μ¥
- ν μ°ν μ²λ¦¬λ΅ μµμ‹  ν¬μ¦λ§ κ²€μ¦ν•μ—¬ μ§€μ—° μµμ†ν™”
- **μ •ν™•ν 1μ΄ κ°„κ²©μΌλ΅ ν¬μ¦ κ²€μ¦**: μ„λ²„ μ²λ¦¬ μ‹κ°„μ„ κ³ λ ¤ν• μ „μ†΅ κ°„κ²©μΌλ΅ μΌμ •ν• κ²€μ¦ μ£ΌκΈ° μ μ§€

### 2. μ‚¬μ©μ κ²½ν— ν–¥μƒ

- λ¶€λ“λ½κ³  λΉ λ¥΄κ² λκ»΄μ§
- μ‹¤μ‹κ°„μ„± ν–¥μƒ μ²΄κ° - ν„μ¬ λ¨μµμ΄ μ¦‰μ‹ μ μ©λ¨
- μΉ΄μ΄νΈλ‹¤μ΄ μ¤‘ ν¬μ¦ λ³€κ²½ μ‹ μ¦‰μ‹ λ°μ
- μΌμ •ν• κ²€μ¦ κ°„κ²©μΌλ΅ μμΈ΅ κ°€λ¥ν• μ‚¬μ©μ κ²½ν— μ κ³µ

### 3. μƒνƒ κΈ°λ° λ™μ  ν κ΄€λ¦¬

- μΉ΄μ΄νΈλ‹¤μ΄ μ¤‘: μµμ‹  μ”μ²­λ§ μ¦‰μ‹ μ²λ¦¬ (ν μ°ν)
- μΌλ° μƒν™©: μμ°¨ μ²λ¦¬ μ μ§€ (FIFO)
- μƒνƒ μ „ν™μ— λ”°λ¥Έ μλ™ μµμ ν™”

### 4. λ©”λ¨λ¦¬ ν¨μ¨μ„±

- μΉ΄μ΄νΈλ‹¤μ΄ λ¨λ“ μ§„μ… μ‹ μ¤λλ μ”μ²­ μ¦‰μ‹ μ·¨μ† λ° λ©”λ¨λ¦¬ ν•΄μ 
- λ¶ν•„μ”ν• μ”μ²­ μ²λ¦¬ λ°©μ§€λ΅ λ¦¬μ†μ¤ μ μ•½

## κµ¬ν„ μ„Έλ¶€μ‚¬ν•­

### ν΄λΌμ΄μ–ΈνΈ (WebcamPage.tsx)

- `captureIntervalRef`: μ „μ†΅ κ°„κ²©μ„ λ™μ μΌλ΅ κ΄€λ¦¬ν•λ” ref
- `isValid` μƒνƒ λ³€κ²½ μ‹ μ „μ†΅ κ°„κ²© μλ™ μ΅°μ •
  - `isValid = true`: 720ms κ°„κ²© (μΉ΄μ΄νΈλ‹¤μ΄ λ¨λ“, μ •ν™•ν 1μ΄ κ°„κ²© ν¬μ¦ κ²€μ¦)
  - `isValid = false`: 100ms κ°„κ²© (μΌλ° λ¨λ“)

**μ½”λ“ μμ‹:**
```typescript
if (isValid) {
  // μΉ΄μ΄νΈλ‹¤μ΄ λ¨λ“: μ •ν™•ν 1μ΄ κ°„κ²©μΌλ΅ ν¬μ¦ κ²€μ¦ν•κΈ° μ„ν•΄
  // μ„λ²„ μ²λ¦¬ μ‹κ°„(ν‰κ·  230ms) + λ„¤νΈμ›ν¬ μ§€μ—°(50ms) = 280msλ¥Ό κ³ λ ¤ν•μ—¬
  // ν΄λΌμ΄μ–ΈνΈ μ „μ†΅ κ°„κ²© = 1000ms - 280ms = 720ms
  captureIntervalRef.current = setInterval(captureAndSendFrame, 720);
} else {
  // μΌλ° λ¨λ“: 100ms κ°„κ²©μΌλ΅ μ „μ†΅
  captureIntervalRef.current = setInterval(captureAndSendFrame, 100);
}
```

### μ„λ²„ (socket.gateway.ts)

- `countdownMode`: ν΄λΌμ΄μ–ΈνΈλ³„ μΉ΄μ΄νΈλ‹¤μ΄ λ¨λ“ μƒνƒ μ¶”μ 
- `handleStream`: μΉ΄μ΄νΈλ‹¤μ΄ λ¨λ“ μ²΄ν¬ λ° λ¶„κΈ° μ²λ¦¬
  - μΉ΄μ΄νΈλ‹¤μ΄ λ¨λ“: `processRequestImmediately()` νΈμ¶
  - μΌλ° λ¨λ“: νμ— μ¶”κ°€ ν›„ `processNextRequest()` νΈμ¶
- `processRequestImmediately`: μΉ΄μ΄νΈλ‹¤μ΄ λ¨λ“μ© μ¦‰μ‹ μ²λ¦¬ λ©”μ„λ“
- `processNextRequest`: μΌλ° λ¨λ“μ© ν μ²λ¦¬ λ©”μ„λ“
  - κ²€μ¦ μ„±κ³µ μ‹: μΉ΄μ΄νΈλ‹¤μ΄ λ¨λ“ ν™μ„±ν™” λ° ν μ •λ¦¬
  - κ²€μ¦ μ‹¤ν¨ μ‹: μΉ΄μ΄νΈλ‹¤μ΄ λ¨λ“ λΉ„ν™μ„±ν™”

## μ„±λ¥ κ°μ„  ν¨κ³Ό

- **μ‹¤μ‹κ°„μ„± ν–¥μƒ**: μΉ΄μ΄νΈλ‹¤μ΄ μ¤‘ μµμ‹  ν¬μ¦ κ²€μ¦ μ§€μ—° μ κ±°
- **μ‚¬μ©μ„± κ°μ„ **: ν¬μ¦ λ³€κ²½ μ‹ μ¦‰μ‹ λ°μ
- **λ¦¬μ†μ¤ ν¨μ¨**: λ¶ν•„μ”ν• μ¤λλ μ”μ²­ μ²λ¦¬ λ°©μ§€
- **μ•μ •μ„± ν–¥μƒ**: μ²λ¦¬ μ‹κ°„ λ³€λ™μ„±μ— λ€ν• λ€μ‘λ ¥ κ°•ν™”
- **μΌμ •ν• κ²€μ¦ κ°„κ²©**: μ •ν™•ν 1μ΄ κ°„κ²©μΌλ΅ ν¬μ¦ κ²€μ¦ν•μ—¬ μμΈ΅ κ°€λ¥ν• λ™μ‘ λ³΄μ¥

version: '3.9'

# 프로덕션용 Docker Compose 설정
# npm run prod 실행 시 모든 서비스를 Docker 컨테이너로 실행

services:
  postgres:
    image: postgres:15-alpine
    container_name: ai-pass-postgres
    restart: unless-stopped
    networks:
      - ai-pass-prod
    environment:
      POSTGRES_DB: ${DATABASE_NAME:-ai_pass}
      POSTGRES_USER: ${DATABASE_USER:-ai_pass}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD:-prod_password}
    ports:
      - '${FORWARD_POSTGRES_PORT:-5432}:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${DATABASE_USER:-ai_pass} -d ${DATABASE_NAME:-ai_pass}']
      interval: 10s
      timeout: 5s
      retries: 5

  mongodb:
    image: mongo:7.0
    container_name: ai-pass-mongodb
    restart: unless-stopped
    networks:
      - ai-pass-prod
    environment:
      MONGO_INITDB_DATABASE: ${MONGO_DATABASE:-ai-pass}
    ports:
      - '${FORWARD_MONGO_PORT:-27017}:27017'
    volumes:
      - mongodb_data:/data/db
    healthcheck:
      test: ['CMD', 'mongosh', '--eval', 'db.adminCommand("ping")']
      interval: 10s
      timeout: 5s
      retries: 5

  # AI 모델 서버 (Python Flask)
  model-server:
    build:
      context: ../AI-pass-model
      dockerfile: Dockerfile
    container_name: ai-pass-model-server
    networks:
      - ai-pass-prod
    expose:
      - "5001"
    # 내부 네트워크 전용 (포트 노출 안 함)
    restart: unless-stopped

  # 백엔드 서버 (NestJS)
  backend:
    build:
      context: .
      dockerfile: apps/server/Dockerfile
    container_name: ai-pass-backend
    networks:
      - ai-pass-prod
    depends_on:
      postgres:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      model-server:
        condition: service_started
    environment:
      NODE_ENV: production
      # Docker 컨테이너 내부에서는 서비스 이름 사용
      DATABASE_HOST: postgres
      DATABASE_PORT: 5432
      DATABASE_NAME: ${DATABASE_NAME:-ai_pass}
      DATABASE_USER: ${DATABASE_USER:-ai_pass}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD}
      MONGO_HOST: mongodb
      MONGO_PORT: 27017
      MONGO_DATABASE: ${MONGO_DATABASE:-ai-pass}
      # OAuth 설정
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      GOOGLE_CALLBACK_URL: ${GOOGLE_CALLBACK_URL}
      # 모델 서버 URL (Docker 서비스 이름 사용)
      MODEL_SERVER_URL: ${MODEL_SERVER_URL:-http://model-server:5001}
      # 세션 설정
      SESSION_SECRET: ${SESSION_SECRET}
      SESSION_MAX_AGE: ${SESSION_MAX_AGE:-1800}
      # 프론트엔드 URL
      FRONTEND_URL: ${FRONTEND_URL}
      # 서버 포트 (5002로 통일)
      SERVER_PORT: 5002
      # Admin 이메일
      ADMIN_EMAILS: ${ADMIN_EMAILS:-}
    expose:
      - "5002"
    # 내부 네트워크 전용 (포트 노출 안 함, Nginx가 프록시)
    restart: unless-stopped

  # 프론트엔드 빌더 (React 빌드 전용)
  frontend-builder:
    build:
      context: .
      dockerfile: apps/client/Dockerfile
    container_name: ai-pass-frontend-builder
    networks:
      - ai-pass-prod
    volumes:
      - frontend_dist:/usr/share/nginx/html
    # 빌드만 수행하고 종료 (Nginx가 볼륨을 사용)

  # Nginx 리버스 프록시
  nginx:
    image: nginx:alpine
    container_name: ai-pass-nginx
    networks:
      - ai-pass-prod
    depends_on:
      - frontend-builder
      - backend
    ports:
      - '${FORWARD_HTTP_PORT:-80}:80'
      - '${FORWARD_HTTPS_PORT:-443}:443'
    volumes:
      - frontend_dist:/usr/share/nginx/html:ro
      - ./nginx/nginx-production.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./certbot/conf:/etc/letsencrypt:ro
      - ./certbot/www:/var/www/certbot:ro
    restart: unless-stopped

networks:
  ai-pass-prod:
    name: ai-pass-prod-network
    driver: bridge

volumes:
  postgres_data:
    name: ai-pass-postgres-prod
  mongodb_data:
    name: ai-pass-mongodb-prod
  frontend_dist:
    name: ai-pass-frontend-dist
